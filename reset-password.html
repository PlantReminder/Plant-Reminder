<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resetear Contraseña</title>
  </head>
  <body>
    <h2>Restablecer Contraseña</h2>
    <form id="resetForm">
      <input type="password" id="newPassword" placeholder="Nueva contraseña" required />
      <button type="submit">Actualizar Contraseña</button>
    </form>
    <p id="message"></p>

    <!-- Importa el cliente de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
      // Inicializa el cliente de Supabase con tu URL y API Key pública
      const SUPABASE_URL = 'https://kerijldtrzlwaawlpdcw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlcmlqbGR0cnpsd2Fhd2xwZGN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwMDE5OTEsImV4cCI6MjA1ODU3Nzk5MX0.5FIsIG5e8oGV_38PCQc0QNtR2SYl-1IKkUaa11ZL280';
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Función para extraer el token de la URL
      function getTokenFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token'); // Supabase pasa el token en el parámetro "token"
      }

      const token = getTokenFromUrl();

      // Si se recibió el token, inicia el proceso de autenticación en modo "recuperación"
      if (token) {
        // Establece la sesión con el token de recuperación (se usa tanto como access como refresh token)
        supabase.auth
          .setSession({
            access_token: token,
            refresh_token: token,
          })
          .then(({ data, error }) => {
            if (error) {
              document.getElementById('message').innerText = 'Error estableciendo sesión: ' + error.message;
            } else {
              document.getElementById('message').innerText = 'Sesión establecida. Puedes actualizar tu contraseña.';
            }
          });
      } else {
        document.getElementById('message').innerText = 'Token no encontrado en la URL.';
      }

      // Procesa el formulario de actualización de contraseña
      document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        if (!newPassword || newPassword.length < 6) { // Puedes agregar validaciones adicionales
          document.getElementById('message').innerText = 'Por favor, ingresa una contraseña válida (mínimo 6 caracteres).';
          return;
        }

        // Actualiza la contraseña del usuario
        const { error } = await supabase.auth.updateUser({ password: newPassword });
        if (error) {
          document.getElementById('message').innerText = 'Error actualizando la contraseña: ' + error.message;
        } else {
          document.getElementById('message').innerText = 'Contraseña actualizada con éxito.';
          // Puedes redireccionar o mostrar una confirmación adicional
        }
      });
    </script>
  </body>
</html>
